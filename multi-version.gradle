// pre-processor for MultiVersion
interface InjExOps {
    @Inject
    ExecOperations getExecOps()
}

tasks.register("preprocessMultiVersion") {
    def inj = project.objects.newInstance(InjExOps)
    doLast {
        copy {
            from "src"
            into "tmp"
        }
        fileTree("src") each { file ->
            inj.execOps.exec {
                commandLine "node", "./MultiVersion/preprocess.js", file
            }
        }
        inj.execOps.exec {
            commandLine "node", "./MultiVersion/finalize.js"
        }
    }
}

tasks.register("cleanupMultiVersion") {
    doLast {
        copy {
            from "src"
            into "tmp2"
        }
        delete "src"
        copy {
            from "tmp"
            into "src"
        }
        delete "tmp"
    }
}

compileJava {
    dependsOn preprocessMultiVersion
    finalizedBy cleanupMultiVersion
}
